!function e(t,i,n){function o(a,u){if(!i[a]){if(!t[a]){var s="function"==typeof require&&require;if(!u&&s)return s(a,!0);if(r)return r(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var l=i[a]={exports:{}};t[a][0].call(l.exports,function(e){var i=t[a][1][e];return o(i||e)},l,l.exports,e,t,i,n)}return i[a].exports}for(var r="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}({1:[function(e,t,i){"use strict";var n=e("./routes"),o=e("./components/main/mainController"),r=e("./components/test/testController"),a=e("./directives/track-directive"),u=e("./directives/tickSlider-directive");!function(){var e=angular.module("myApp",["ngRoute"]);e.config(["$routeProvider",n.initRoutes]),e.controller("mainController",["$scope",o.mainController]),e.controller("testController",["$scope",r.testController]),e.directive("tickSlider",u.tickSliderDirective),e.directive("theTrack",["supportedAudioFormats",a.trackDirective]);var t=new Set;t.add("audio/wav"),t.add("audio/x-wav"),t.add("audio/mp3"),t.add("audio/x-mp3"),t.add("audio/ogg"),t.add("audio/x-ogg"),e.constant("supportedAudioFormats",t)}()},{"./components/main/mainController":6,"./components/test/testController":7,"./directives/tickSlider-directive":8,"./directives/track-directive":9,"./routes":10}],2:[function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(i,"__esModule",{value:!0}),i.DrumMachine=void 0;var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),r=e("./audio-loader"),a=e("../utils/utils"),u=e("./Track");i.DrumMachine=function(){function e(){n(this,e),this.tag="[DrumMachine.js]";var t=window.AudioContext||window.webkitAudioContext;this.audioContext=new t,this.bpm=120,this.tickTime=60/this.bpm/4,this.isPlaying=!1,this.buffers={},this.tracks={},this.defaultBuffersLoaded=!1,this.defaultTracksLoaded=!1,this.tracksInSolo=new Set,this.tracksInMute=new Set,this.currentTickIndex=1,this.soundURLs={kick:"app/assets/audio/kick.wav",snare:"app/assets/audio/snare.wav",hat:"app/assets/audio/hat.wav",ride:"app/assets/audio/ride.wav"},(0,a.checkIfiOSdevice)()?this._enableAudioContextForiOS():this.audioContextEnabled=!0}return o(e,[{key:"_enableAudioContextForiOS",value:function(){var e=this;$(document).ready(function(){var t=$("<button/>",{visibility:"hidden"});t.on("touchstart",function(){var t=e.audioContext.createBuffer(1,1,22050),i=e.audioContext.createBufferSource();i.buffer=t,i.start()}),t.trigger("touchstart"),e.audioContextEnabled=!0,console.log("AudioContext enabled for iOS")})}},{key:"_loadDefaultBuffers",value:function(){var e=this,t=this.audioContext,i=this.soundURLs;return new Promise(function(n,o){Promise.all([(0,r.audioLoader)(t,i.kick),(0,r.audioLoader)(t,i.snare),(0,r.audioLoader)(t,i.hat),(0,r.audioLoader)(t,i.ride)]).then(function(t){e.buffers.kick=t[0],e.buffers.snare=t[1],e.buffers.hat=t[2],e.buffers.ride=t[3],e.defaultBuffersLoaded=!0,console.log(e.buffers),e.defaultBuffersLoaded=!0,console.log("Default buffers loaded"),n("Default buffers loaded")},function(e){o(e)})})}},{key:"_initDefaultTracks",value:function(){if(this.defaultBuffersLoaded){this.tracks={};var e=new u.Track(this,"kick",this.buffers.kick);e.setTicksFromArray([0,4,8,12]);var t=new u.Track(this,"snare",this.buffers.snare,1,.1);t.setTicksFromArray([4,12]);var i=new u.Track(this,"hat",this.buffers.hat,.85,-1);i.setTicksFromArray([{index:0,volume:.9},{index:1,volume:.5},{index:2,volume:1.2},{index:3,volume:.4},{index:4,volume:.9},{index:5,volume:.5},{index:6,volume:1.2},{index:7,volume:.4},{index:8,volume:.9},{index:9,volume:.5},{index:10,volume:1.2},{index:11,volume:.4},{index:12,volume:.9},{index:13,volume:.5},{index:14,volume:1.2},{index:15,volume:.4}]),this.tracks[e.id]=e,this.tracks[t.id]=t,this.tracks[i.id]=i,this.defaultTracksLoaded=!0,console.log("Default tracks loaded",this.tracks)}}},{key:"_onBpmChanged",value:function(){this.tickTime=60/this.bpm/4}},{key:"_start",value:function(){function e(){o<=i.currentTime+t.tickTime&&($.each(t.tracks,function(e,t){if(!t.mute&&t.buffer){var n=t.ticks[r];if(n.active){var a=i.createBufferSource();a.buffer=t.buffer;var u=i.createGain();a.connect(u),u.gain.value=n.volume,u.connect(t.gainNode),a.start(o)}}}),t.currentTickIndex=r,o+=t.tickTime,r+=1,r=16===r?0:r),window.setTimeout(e,0)}if(!this.audioContextEnabled)return void console.log("Cannot play: AudioContext is not enabled.");if(this.isPlaying)return void console.log("Cannot play: it is already playing.");if(!this.defaultTracksLoaded)return void console.log("Cannot play: default tracks not loaded.");this.isPlaying=!0;var t=this,i=this.audioContext,n=i.currentTime,o=n+t.tickTime,r=0;e()}},{key:"_playSound",value:function(e,t){var i=this.audioContext,n=i.createBufferSource();n.buffer=this.buffers[e],n.connect(i.destination),n.start(t)}},{key:"addNewTrack",value:function(e,t){var i=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(this.buffers.hasOwnProperty(e))return void console.log("Track name collision");(0,r.audioLoader)(this.audioContext,t).then(function(t){i.buffers[e]=t;var r=new u.Track(i,e,i.buffers[e],n,o);i.tracks[r.id]=r,console.log("Added track ",r)},function(e){console.log("ERROR",e)})}},{key:"removeTrack",value:function(e){delete this.tracks[e]}},{key:"soloTrack",value:function(e){if(this.tracks.hasOwnProperty(e)){var t=this.tracks[e],i=this.tracksInSolo,n=this.tracksInMute;i.has(t)||n.has(t)?i.has(t)?(i.delete(t),t.solo=!1,i.size>0?(n.add(t),t.mute=!0):(n.clear(),i.clear(),$.each(this.tracks,function(e,t){t.mute=!1,t.solo=!1}))):(i.add(t),t.solo=!0,t.mute=!1,1===i.size&&$.each(this.tracks,function(t,i){t!==e&&(n.add(i),i.mute=!0)})):(i.add(t),t.solo=!0,t.mute=!1,$.each(this.tracks,function(t,o){t!==e&&(i.has(o)||(n.add(o),o.mute=!0,o.solo=!1))}))}}},{key:"muteTrack",value:function(e){if(this.tracks.hasOwnProperty(e)){var t=this.tracks[e],i=this.tracksInSolo,n=this.tracksInMute;i.has(t)||n.has(t)?i.has(t)?(i.delete(t),n.add(t),t.solo=!1,t.mute=!0,0===i.size&&$.each(this.tracks,function(t,i){t!==e&&(n.delete(i),i.mute=!1)})):n.has(t)&&(i.size>0?(n.delete(t),i.add(t),t.mute=!1,t.solo=!0):(n.delete(t),t.mute=!1)):(n.add(t),t.mute=!0,t.solo=!1)}}},{key:"bpm",get:function(){return this._bpm},set:function(e){e!==this._bpm&&(this._bpm=e,this._onBpmChanged())}}]),e}()},{"../utils/utils":11,"./Track":4,"./audio-loader":5}],3:[function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(i,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();i.Tick=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;n(this,e),this.index=t,this.active=i,this.volume=o}return o(e,[{key:"volume",get:function(){return this._volume},set:function(e){this._volume=e>1?1:e}}]),e}()},{}],4:[function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(i,"__esModule",{value:!0}),i.Track=void 0;var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=e("./Tick"),u=e("../utils/utils");i.Track=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"track_default",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]&&arguments[5];n(this,e),this.id=(0,u.guid)(),this.drumMachine=t,this.audioContext=t.audioContext,this.name=i,this.buffer=o,this.solo=!1,this.mute=s,this.ticks=[],this.pannerNodeSupported=!1,this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=r,"function"==typeof this.audioContext.createStereoPanner?(this.pannerNode=this.audioContext.createStereoPanner(),this.pannerNode.pan.value=a,this.gainNode.connect(this.pannerNode),this.pannerNode.connect(this.audioContext.destination),this.pannerNodeSupported=!0,console.log("Stereo panner supported")):(this.gainNode.connect(this.audioContext.destination),console.log("Stereo panner not supported")),this._initTicks()}return r(e,[{key:"_initTicks",value:function(){this.ticks=[];for(var e=0;e<16;++e)this.ticks.push(new a.Tick(e))}},{key:"setTick",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;e<0||e>15||(this.ticks[e].volume=i,this.ticks[e].active=t)}},{key:"setTicksFromArray",value:function(e){var t=this;e.forEach(function(e){if("object"===(void 0===e?"undefined":o(e))){if(!e.index||e.index<0||e.index>15)return;var i=t.ticks[e.index];i.volume=e.volume?e.volume:1,i.active=!e.active||e.active}else t.ticks[e].active=!0})}},{key:"setBuffer",value:function(e,t){this.buffer=e,console.log("Track "+this.name+": audio buffer changed ( "+t+" )")}},{key:"playSound",value:function(){if(this.audioContext){var e=this.audioContext.createBufferSource();e.buffer=this.buffer,e.connect(this.audioContext.destination),e.start()}}}]),e}()},{"../utils/utils":11,"./Tick":3}],5:[function(e,t,i){"use strict";function n(e,t){return new Promise(function(i,n){if(!e)return void n("Missing audio context parameter.");if(!t)return void n("Missing url parameter");var o=new XMLHttpRequest;o.open("GET",t),o.responseType="arraybuffer",o.onload=function(){try{e.decodeAudioData(o.response,function(e){i(e)})}catch(e){n(e)}},o.send()})}Object.defineProperty(i,"__esModule",{value:!0}),i.audioLoader=n},{}],6:[function(e,t,i){"use strict";function n(e){function t(e){i.removeTrack(e.id)}e.title="Main Controller",e.tracks=[],e.ticksElements=[],e.removeTrack=t,console.log("Main controller");var i=new a.DrumMachine;e.startSequencer=function(){i._start()},o(e,i),r(i)}function o(e,t){t._loadDefaultBuffers().then(function(){t._initDefaultTracks(),e.tracks=t.tracks,e.$apply()},function(e){console.log(e)})}function r(e){(new dat.GUI).add(e,"bpm",50,220).onChange(function(t){e.bpm=Math.floor(e.bpm)})}Object.defineProperty(i,"__esModule",{value:!0}),i.mainController=n;var a=e("../../audio/DrumMachine")},{"../../audio/DrumMachine":2}],7:[function(e,t,i){"use strict";function n(e){e.title="Test Controller",console.log("Test Controller")}Object.defineProperty(i,"__esModule",{value:!0}),i.testController=n},{}],8:[function(e,t,i){"use strict";function n(){return{restrict:"AE",replace:"false",scope:{tick:"=",ticksElements:"=",resizeTick:"="},link:function(e,t,i){e.ticksElements.push(t),t.slider({min:0,max:100,orientation:"vertical",value:e.tick.active?100*e.tick.volume:0,slide:function(t,i){e.tick.active||(e.tick.active=!0),e.tick.volume=.01*i.value}}).draggable()}}}Object.defineProperty(i,"__esModule",{value:!0}),i.tickSliderDirective=n},{}],9:[function(e,t,i){"use strict";function n(e){return{restrict:"AE",replace:"false",scope:{track:"=",ticksElements:"=",removeTrack:"="},templateUrl:"app/directives/templates/trackDirTemplate.html",link:function(t,i,n){function o(e){var t=i.find(".ticks-container").width();console.log(t);Math.floor((t-120)/16)}function r(i){if(i&&!(i.length<1)){var n=i[0];if(!e.has(n.type))return void console.log("File format not supported by Web Audio API");var o=new FileReader;o.onload=function(e){t.track.audioContext.decodeAudioData(e.target.result,function(e){t.track.setBuffer(e,n.name)})},o.readAsArrayBuffer(n)}}function a(e){i.hasClass("track-dragfile")||i.addClass("track-dragfile"),e.stopPropagation(),e.preventDefault()}function u(e){e.stopPropagation(),e.preventDefault(),r(e.originalEvent.dataTransfer.files),s()}function s(e){i.hasClass("track-dragfile")&&i.removeClass("track-dragfile"),e&&(e.stopPropagation(),e.preventDefault())}function c(){t.track.playSound()}function l(){t.track.drumMachine.soloTrack(t.track.id)}function d(){t.track.drumMachine.muteTrack(t.track.id)}t.resizeTick=o,t.handleFiles=r,t.playSound=c,t.onSoloTrack=l,t.onMuteTrack=d,i.find('button[name="removeTrackButton"]').button({icon:"ui-icon-close",showLabel:!1}),i.find('button[name="playSoundButton"]').button({icon:"ui-icon-circle-triangle-e",showLabel:!1}),i.find('div[id="trackVolumeSlider"]').slider({min:0,max:100,orientation:"horizontal",value:100*t.track.gainNode.gain.value,slide:function(e,i){t.track.gainNode.gain.value=.01*i.value}}).draggable(),t.track.pannerNodeSupported?i.find('div[id="trackPanSlider"]').slider({min:-100,max:100,orientation:"horizontal",value:100*t.track.pannerNode.pan.value,slide:function(e,i){t.track.pannerNode.pan.value=.01*i.value}}).draggable():(i.find('div[id="trackPanSlider"]').remove(),i.find(".pan-label").remove(),i.find('div[id="trackVolumeSlider"]').css({})),i.find("button[name=soloTrackButton]").button({}),i.find("button[name=muteTrackButton]").button({}),i.on("dragover",a),i.on("drop",u),i.on("dragleave",s)}}}Object.defineProperty(i,"__esModule",{value:!0}),i.trackDirective=n},{}],10:[function(e,t,i){"use strict";function n(e){e.when("/",{controller:"mainController",templateUrl:"app/components/main/mainView.html"}),e.when("/test",{controller:"testController",templateUrl:"app/components/test/testView.html"}),e.otherwise({redirectTo:"/"})}Object.defineProperty(i,"__esModule",{value:!0}),i.initRoutes=n},{}],11:[function(e,t,i){"use strict";function n(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream}function o(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}Object.defineProperty(i,"__esModule",{value:!0}),i.checkIfiOSdevice=n,i.guid=o},{}]},{},[1]);
//# sourceMappingURL=app.bundle.min.js.map
